pipeline {
    agent any

    stages {

        stage('Setup') {
            steps {
                echo 'Setting up Jenkins workspace...'
                checkout scm

                sh '''
                    set -e
                    echo "Workspace: $(pwd)"
                    echo "Updating packages and installing prerequisites..."
                    sudo apt-get update -y
                    sudo apt-get install -y curl unzip jq
                '''
            }
        }

        stage('Install Terraform') {
            steps {
                sh '''
                    if ! command -v terraform >/dev/null 2>&1; then
                      echo "Installing Terraform..."
                      TERRAFORM_VERSION="1.6.6"
                      curl -fsSL https://releases.hashicorp.com/terraform/${TERRAFORM_VERSION}/terraform_${TERRAFORM_VERSION}_linux_amd64.zip -o terraform.zip
                      unzip -o terraform.zip
                      sudo mv terraform /usr/local/bin/
                    fi
                    terraform version
                '''
            }
        }

        // stage('Terraform with AWS Credentials') {
        //     steps {
        //         withCredentials([
        //             [$class: 'AmazonWebServicesCredentialsBinding',
        //             credentialsId: 'aws-terraform-creds']
        //         ]) {
        //             sh '''
        //                 export AWS_DEFAULT_REGION=us-east-1
        //                 terraform init
        //                 terraform plan
        //                 terraform apply -auto-approve
        //             '''
        //         }
        //     }
        // }
    }
}